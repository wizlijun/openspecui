<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  background: #1a1a2e;
  color: #c8c8d0;
  font-family: 'SF Mono', 'Menlo', 'Monaco', monospace;
  font-size: 11px;
  line-height: 1.5;
  overflow: hidden;
}
#log-container {
  height: 100vh;
  overflow-y: auto;
  padding: 6px 10px;
}
.context-menu {
  display: none;
  position: fixed;
  background: #2a2a4a;
  border: 1px solid #3a3a5a;
  border-radius: 4px;
  padding: 4px 0;
  z-index: 1000;
  min-width: 100px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.4);
}
.context-menu.visible {
  display: block;
}
.context-menu-item {
  padding: 4px 16px;
  cursor: pointer;
  color: #c8c8d0;
  font-size: 11px;
}
.context-menu-item:hover {
  background: #3a3a5a;
}
.log-entry {
  display: flex;
  gap: 8px;
  padding: 2px 0;
  border-bottom: 1px solid #1e1e38;
}
.log-entry:hover {
  background: #1e1e38;
}
.log-time {
  color: #555577;
  white-space: nowrap;
  flex-shrink: 0;
}
.log-dir {
  padding: 1px 4px;
  border-radius: 3px;
  font-size: 10px;
  font-weight: 600;
  white-space: nowrap;
  flex-shrink: 0;
}
.log-dir.send { background: #1a3a2a; color: #4ade80; }
.log-dir.recv { background: #1a2a3a; color: #60a5fa; }
.log-dir.callback { background: #3a2a1a; color: #fbbf24; }
.log-dir.hook { background: #2a1a3a; color: #c084fc; }
.log-dir.info { background: #2a2a3a; color: #8888aa; }
.log-type {
  color: #aaaacc;
  white-space: nowrap;
  flex-shrink: 0;
  min-width: 120px;
}
.log-detail {
  color: #c8c8d0;
  word-break: break-all;
  white-space: pre-wrap;
}
.log-detail .truncated {
  color: #555577;
  font-style: italic;
}
</style>
</head>
<body>
<div id="log-container"></div>
<div id="context-menu" class="context-menu">
  <div class="context-menu-item" onclick="clearLog()">Clear</div>
</div>

<script>
var logContainer = document.getElementById('log-container');
var contextMenu = document.getElementById('context-menu');
var autoScroll = true;
var maxEntries = 2000;

// Context menu
document.addEventListener('contextmenu', function(e) {
  e.preventDefault();
  contextMenu.style.left = e.clientX + 'px';
  contextMenu.style.top = e.clientY + 'px';
  contextMenu.classList.add('visible');
});

document.addEventListener('click', function() {
  contextMenu.classList.remove('visible');
});

function clearLog() {
  logContainer.innerHTML = '';
}

function getTime() {
  var d = new Date();
  return d.toLocaleTimeString('en-US', { hour12: false }) + '.' +
    String(d.getMilliseconds()).padStart(3, '0');
}

function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}

function truncate(str, max) {
  if (!str || str.length <= max) return escapeHtml(str);
  return escapeHtml(str.substring(0, max)) + '<span class="truncated"> ...(' + str.length + ' chars)</span>';
}

// Strip ANSI escape sequences for display
function stripAnsi(str) {
  if (!str) return '';
  return str.replace(/\x1b\[[0-9;]*[a-zA-Z]/g, '')
            .replace(/\x1b\].*?\x07/g, '')
            .replace(/\x1b\[\?[0-9;]*[hl]/g, '')
            .replace(/\x1b[()][AB012]/g, '')
            .replace(/[\x00-\x08\x0e-\x1f]/g, '');
}

function addLog(direction, type, detail) {
  var entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML =
    '<span class="log-time">' + getTime() + '</span>' +
    '<span class="log-dir ' + direction + '">' +
      (direction === 'send' ? '→ SEND' :
       direction === 'recv' ? '← RECV' :
       direction === 'callback' ? '⟲ CALLBACK' :
       direction === 'hook' ? '⚡ HOOK' :
       'ℹ INFO') +
    '</span>' +
    '<span class="log-type">' + escapeHtml(type) + '</span>' +
    '<span class="log-detail">' + detail + '</span>';

  logContainer.appendChild(entry);

  // Trim old entries
  while (logContainer.children.length > maxEntries) {
    logContainer.removeChild(logContainer.firstChild);
  }

  if (autoScroll) {
    logContainer.scrollTop = logContainer.scrollHeight;
  }
}

// ─── API called from Python ────────────────────────────────────────

window.logSend = function(type, detail) {
  addLog('send', type, truncate(detail, 300));
};

window.logRecv = function(type, detail) {
  addLog('recv', type, truncate(stripAnsi(detail), 300));
};

window.logCallback = function(type, detail) {
  addLog('callback', type, truncate(detail, 300));
};

window.logHook = function(type, detail) {
  addLog('hook', type, truncate(detail, 300));
};

window.logInfo = function(type, detail) {
  addLog('info', type, truncate(detail, 300));
};

// Initial log
addLog('info', 'Log Panel', 'Message log initialized. Monitoring terminal interactions...');
</script>
</body>
</html>
